name: Scrape Golf Odds

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run scraper
        run: ./gradlew run --console=plain 2>&1 | tee output.txt
        continue-on-error: true

      - name: Generate HTML
        run: |
          mkdir -p public
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          # Convert ANSI colors to HTML and escape special chars
          python3 << 'PYTHON'
          import html
          import re
          import sys

          with open('output.txt', 'r') as f:
              content = f.read()

          # Escape HTML special characters
          content = html.escape(content)

          # Convert ANSI green to span
          content = re.sub(r'\x1b\[32m', '<span class="positive">', content)
          content = re.sub(r'\x1b\[0m', '</span>', content)

          with open('output_escaped.txt', 'w') as f:
              f.write(content)
          PYTHON

          OUTPUT=$(cat output_escaped.txt)

          cat > public/index.html << HTMLEOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="refresh" content="600">
            <title>Golf Odds - E/W Arbitrage</title>
            <style>
              body {
                background: #1a1a2e;
                color: #eee;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                font-size: 12px;
                padding: 20px;
                margin: 0;
              }
              h1 { color: #00d4ff; margin-bottom: 5px; }
              .timestamp { color: #888; margin-bottom: 20px; }
              pre {
                background: #16213e;
                padding: 20px;
                border-radius: 8px;
                overflow-x: auto;
                line-height: 1.4;
              }
              .positive { color: #00ff88; font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>Golf E/W Arbitrage Opportunities</h1>
            <div class="timestamp">Last updated: ${TIMESTAMP}</div>
            <pre>${OUTPUT}</pre>
          </body>
          </html>
          HTMLEOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
